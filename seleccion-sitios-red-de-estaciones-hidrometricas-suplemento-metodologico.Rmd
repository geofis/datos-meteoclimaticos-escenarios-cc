---
title: "Selección de sitios para el establecimiento de una red de estaciones hidrométricas usando decisión multicriterio y análisis hidrológico con modelo digital de elevaciones. Suplemento metodológico"
author: "José Martínez<br>Michela Izzo"
output:
  # bookdown::github_document2:
  #   number_sections: false
  #   fig_caption: yes
  bookdown::html_document2:
    number_sections: false
    code_folding: hide
    fig_caption: yes
    md_extensions: "-fancy_lists"
editor_options: 
  chunk_output_type: console
always_allow_html: true
references: ref/biblio.bib
bibliography: ref/biblio.bib
---

```{r supsetup, include=FALSE}
knitr::opts_chunk$set(
  cache = F, 
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  out.width = '100%',
  dpi = 300)
# options(digits = 3)
```

`r if(knitr::opts_knit$get("rmarkdown.pandoc.to") == 'gfm-yaml_metadata_block') 'Versión HTML (más legible e interactiva), [aquí](https://geofis.github.io/datos-meteoclimaticos-escenarios-cc/seleccion-sitios-red-de-estaciones-hidrometricas-suplemento-metodologico.html)'`

`r if(knitr::opts_knit$get("rmarkdown.pandoc.to") == 'latex') 'Versión HTML (quizá más legible), [aquí](https://geofis.github.io/datos-meteoclimaticos-escenarios-cc/seleccion-sitios-red-de-estaciones-hidrometricas-suplemento-metodologico.html)'`

## Procedimiento

A pesar de la importancia vital de los datos hidrométricos para diseñar e implementar políticas efectivas de gestión de recursos hídricos, actualmente, la red de estaciones hidrométricas en funcionamiento en la República Dominicana es limitada y enfrenta diversos desafíos [@burn1997; @indrhi2019inventario; @mishra2010; @mishra2009]. La distribución de estas estaciones es poco uniforme y, las que se encuentran en funcionamiento, están amenazadas por problemas de mantenimiento y reposición debido a los bajos presupuestos asignados para este propósito, y a la falta de personal capacitado y estable [@indrhi2019inventario].

En el año 2019, solo 30 de un total de 170 estaciones hidrométricas inventariadas se encontraban en funcionamiento [@indrhi2019inventario]. Se desconoce el estado actual de la red, pero a la fecha de elaboración de este informe, el personal técnico del INDRHI, indicó que algunas estaciones podrían haber salido del sistema por problemas de nombramiento de personal y mantenimiento. Por lo tanto, es esencial expandir esta red para mejorar la representatividad y la precisión de los datos hidrométricos, lo que constituye una prioridad crítica.

La selección de sitios adecuados para la instalación de estaciones hidrométricas es crucial para la obtención de datos precisos y representativos [@mishra2009]. Se deben considerar varios criterios relevantes, como la heterogeneidad climática y topográfica de la región, ya que estas variables influyen en la distribución de las precipitaciones y, por extensión, en la escorrentía dentro de la cuenca [@design1976hydrological]. Además, la accesibilidad del sitio es fundamental para garantizar que el mantenimiento y la operación de las estaciones se pueda llevar a cabo de manera eficiente [@rojasbriceno2021].

Los criterios arriba mencionados fueron usados por este mismo equipo de investigación para proponer una red de estaciones meteoclimáticas, por lo consideramos oportuno aprovecharlos igualmente para diseñar la red de estaciones hidrométricas. En particular, las estaciones hidrométricas deben colocarse sobre corrientes fluviales donde miden los caudales de agua, por lo que es necesario contar con una red hidrográfica lo suficientemente densa.

Existen al menos dos fuentes de información geográfica sobre la hidrografía dominicana, a saber, la red digitalizada a partir del mapa topográfico nacional escala 1:50,000 (MTN 50k) [@icm1989serie], y documentación técnica no publicada del Instituto Nacional de Recursos Hidráulicos (INDRHI). La primera, aunque es bastante exhaustiva, sólo incluye parte de la red, y no aporta características morfométricas de las corrientes fluviales. La segunda, aunque se conoce de su existencia, no está disponible en repositorios públicos, y no se han encontrado publicaciones sobre la metodología empleada.

El objetivo de este análisis es seleccionar los sitios idóneos para la instalación de estaciones hidrométricas, aprovechando las unidades hexagonales ya elegidas previamente en la propuesta para aumentar la densidad de la red estaciones meteoclimáticas. Adicionalmente, uno de nuestros objetivos específicos es crear, por medios semiautomáticos, una red hidrográfica densa y robusta a partir de fuentes abiertas.

Los resultados de este estudio ofrecen la oportuidad de mejorar la red de estaciones hidrométrica, y tienen el potencial de informar medidas de conservación, planificación y gestión de recursos hídricos a nivel nacional, en un momento en el que la humanidad y, en particular, la sociedad dominicana, se prepara para afrontar los efectos del cambio climático y la consecuente escasez de agua pronosticada.

## Paquetes y funciones

```{r suppaquetes}
library(raster)
library(sf)
library(kableExtra)
library(tidyverse)
library(gdalUtils)
estilo_kable <- function(df, titulo = '', cubre_anchura = T) {
  df %>% kable(format = 'html', escape = F, booktabs = T, digits = 2, caption = titulo) %>%
  kable_styling(bootstrap_options = c("hover", "condensed"), full_width = cubre_anchura)
}
```

## Datos de elevación

Elegimos el Modelo Digital de Elevación del Satélite de Observación Avanzada de la Tierra (ALOS-DEM, por sus siglas en inglés), pues es actualmente la fuente abierta de mayor resolución espacial actualmente disponible. Esta fuente cuenta con una resolución espacial de 12,5 metros, y lo descargamos desde el Centro de Archivo Activo Distribuido (DAAC) del Alaska Satellite Facility (ASF). Con este modelo, extrajimos de manera automática las redes hidrográficas de todo el país.

## Descarga de escenas

Identificamos las escenas necesarias para cubrir el país usando una búsqueda geográfica mediante polígono delimitador. Dado que la misión del ALOS-DEM ofrece escenas de distinta fecha para una misma área, descargamos escenas redundantes que posteriormente excluimos del análisis. La descarga la realizamos por lotes, usando un *script* de Python provisto por el propio ASF.

```{python, eval=F}
python download-all-2023-04-20_00-30-00.py
```


## Crear índice de DEM

Utilizando el índice de huellas de escenas, escribimos un pequeño programa para seleccionar la escena más reciente en las áreas donde contábamos con escenas redundantes. Con esto construimos un índice de DEM seleccionados.

```{r}
ind_orig <- st_read('alos-palsar-dem-rd/asf-datapool-results-2023-04-19_08-31-26.geojson') %>% 
   rownames_to_column('fila') %>% mutate(fila = as.integer(fila))
distancias <- ind_orig %>% st_centroid() %>% st_distance() %>% units::drop_units()
distancias[upper.tri(distancias, diag = T)] <- NA
indices <- which(distancias < 1000, arr.ind = TRUE)
duplicados <- as.data.frame(indices) %>% 
  mutate(dup_id = 1:nrow(indices)) %>% 
  pivot_longer(-dup_id, names_to = 'tipo', values_to = 'fila') %>% 
  select(-tipo)
seleccionados <- duplicados %>%
  inner_join(ind_orig %>% select(fila, startTime) %>% st_drop_geometry) %>% 
  group_by(dup_id) %>% filter(startTime == max(startTime)) %>% pull(fila)
ind_orig_sel <- ind_orig %>% filter(!fila %in% duplicados$fila | fila %in% seleccionados) %>% 
  filter(centerLon < -72.1821)
```

## Extraer DEM seleccionados

Usando la lista de DEM seleccionados

```{r, eval=F}
zip_path <- 'alos-palsar-dem-rd/'
sapply(ind_orig_sel$fileName, 
       function(x)
         unzip(
           zipfile = paste0(zip_path, x),
           exdir = paste0(zip_path, 'dem'), junkpaths = T,
           files = paste0(gsub('.zip', '', x), '/', gsub('zip', 'dem.tif', x)))
       )
```

## Verificar CRS, transformar a zona 19N

```{r, eval=F}
dems_orig_path <- list.files(path = 'alos-palsar-dem-rd/dem', pattern = '*dem.tif', full.names = T)
crs_18n <- names(which(sapply(dems_orig_path, function(x){
  crs_x <- gdal_crs(x)
  is_z18 <- grepl('zone 18N', crs_x[['wkt']])
})))
sapply(crs_18n, function(x) file.rename(from = x, to = gsub('.tif', '_z18n.tif', x)))
crs_18n_ren <- list.files(path = 'alos-palsar-dem-rd/dem', pattern = 'z18n.tif', full.names = T)
sapply(crs_18n_ren, function(x){
  gdalwarp(
  srcfile = x,
  dstfile = gsub('_z18n.tif', '.tif', x), 
  t_srs = 'EPSG:32619', overwrite = T
  # t_srs = CRS('EPSG:32619')@projargs
  )
})
```

## Construir ráster virtual

```{r, eval=F}
gdalbuildvrt(gdalfile = dems_orig_path,
             output.vrt = paste0(paste0(zip_path, 'dem'), '/dem_seamless.vrt'),
             resolution = 'highest', r = 'average')
```

## Relleno de píxeles sin datos

Para esta tarea, utilizamos el complemento de GRASS `r.fill.nulls`, el cual configurar para rellenar píxeles sin datos (vacíos) usando interpolación *spline* bilineal con regularización Tykhonov (*spline* es un método de descomposición de curvas en porciones descritas por polinomios).

```{bash, eval=F}
# Usando Bash, desde la ruta ./alos-palsar-dem-rd/dem
grass --text -c dem_seamless.vrt ./grassdata

# Importar máscara
v.import input=mascara-1km.gpkg output=mascara_1km

# Fijar máscara
r.mask vector=mascara_1km

# Ver ambiente
g.gisenv
## GISDBASE=/media/jose/datos/alos-palsar-dem-rd/dem
## LOCATION_NAME=grassdata
## MAPSET=PERMANENT
## GUI=text
## PID=1632142

# Importar DEM a región de GRASS
time r.import --overwrite input=dem_seamless.vrt output=dem
## real 

# Ver en lista (q para salir)
g.list type=raster

# Rellenar vacíos
time r.fillnulls --overwrite --verbose \
  input=dem method="bilinear" \
  tension=40 smooth=0.1 edge=3 npmin=600 segmax=300 lambda=0.01 \
  output=dem_relleno
# Enviar mensaje al finalizar (ejecutar conjuntamente con anterior)
echo "Job finished" | mail -s "Job finished" zoneminderjr@gmail.com
## real 10m11.925s

# Exportar a GTiff con compresión LZW
time r.out.gdal --overwrite --verbose createopt="COMPRESS=LZW,BIGTIFF=YES" \
  input=dem_relleno \
  format=GTiff type=Float64 output=dem_relleno.tif
# Enviar mensaje al finalizar (ejecutar conjuntamente con anterior)
echo "Job finished" | mail -s "Job finished" zoneminderjr@gmail.com
## real	0m58.924s
```

## Suavizado preservando morfologías

```{bash, eval=F}
# Comenzó a 23.20 de 22 de abril
time ~/WhiteboxTools_linux_amd64/WBT/whitebox_tools \
  --wd='/media/jose/datos/alos-palsar-dem-rd/dem/' \
  --filter=25 --norm_diff=45 --num_iter=5 \
  --run=FeaturePreservingSmoothing --input='dem_relleno.tif' \
  --output='dem_relleno_suavizado.tif' -v
# Enviar mensaje al finalizar (ejecutar conjuntamente con anterior)
echo "Job finished" | mail -s "Job finished" zoneminderjr@gmail.com
## real	9min46.103s
```

## Importar DEM nuevamente a GRASS

```{bash, eval=F}
time r.import input=dem_relleno_suavizado.tif output=dem_suavizado
echo "Job finished" | mail -s "Job finished" zoneminderjr@gmail.com
## real	0m21.593s
```

## Obtener alturas ortométricas

<!-- Pendiente -->

Usar ráster de altura de geoide de La Española a 1 minuto de resolución. Sería una suma simple, pero es necesario aumentar la resolución del ráster antes de proceder. Para esto, usar r.resamp.interp (evaluar con r.resamp.rst): https://grass.osgeo.org/grass82/manuals/r.resamp.interp.html

```{bash, eval=F}

```


## Tallar la red

<!-- Pendiente -->

Tallar la capa de ríos de OSM con r.carve de GRASS GIS, pues es buena para los grandes en zonas bajas.

```{bash, eval=F}

```

## Crear depresiones

<!-- Pendiente. Aunque fue hecho, debe repetirse con el procesamiento nuevo -->

Usar la capa de calizas con depresiones (limestones_with_depressions.gpkg), para combinar con una capa de depresiones según geomórfonos (script de referencia: hidrografia_90m.R)

```{bash, eval=F}

```

## Añadirle depresiones

<!-- Pendiente. Aunque fue hecho, debe repetirse con el procesamiento nuevo -->

```{bash, eval=F}
time r.import input=depresiones.tif output=depresiones
echo "Job finished" | mail -s "Job finished" zoneminderjr@gmail.com
## real	0m0.622s
```

## Ejecutar r.watershed

<!-- Pendiente. Aunque fue hecho, debe repetirse con el procesamiento nuevo -->

Obtener capas de acumulación de flujo, corrientes, redes de drenaje, cuencas.

```{bash, eval=F}
time r.watershed --overwrite --verbose \
  elevation=dem_suavizado depression=depresiones accumulation=accum-de-rwshed \
  stream=stream-de-rwshed drainage=drainage-dir-de-rwshed basin=basins \
  half_basin=half-basins threshold=160
echo "Job finished" | mail -s "Job finished" zoneminderjr@gmail.com
## real	10m46.280s
```

## Frecuencia de inundado

Usar como referencia: https://www.sciencedirect.com/science/article/pii/S1569843222001984

GitHub: https://github.com/ChenZhiheng-NJU/SurfaceWaterMonitoringProject

## Criterios finales elegidos

- Frecuencia de inundado.
- Orden de red.
- Superficie drenada.

A ser posible, añadir estos otros criterios:

- Topographic wetness index.
- SPI, ¿balance hídrico?.
- Litología.
